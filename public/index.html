<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script src="/__/firebase/7.16.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script src="/__/firebase/7.16.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-firestore.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script src="/__/firebase/init.js"></script>
    <!-- sample datasets for simulated disasters -->
    <script src="data.js"></script>
  </head>
  <body>
  <h1>Bloomington EOC</h1>

    <div class="content">

        <div id="map" style="width: 100%; height: 400px; background-color: grey;"></div>

        <ul id="cafe-list"></ul>

        <button onclick='clearDatabase()'>Clear Database</button><br/>
        <button onclick="simulateCall('storm')">Add Call - Storm</button><br/>
        <button onclick="simulateCall('crash')">Add Call - Plane Crash</button><br/>
        <button onclick="simulateCall('explosion')">Add Call - Explosion</button>

    </div>

    <script>
        const db = firebase.firestore();
        var map;
        var mapBounds;
        var dbMarkers = [];
        var mapMarkers = [];

        var shuffledExplosion = shuffle(explosion);
        var shuffledCrash = shuffle(crash);
        var shuffledStorm = shuffle(storm);

        const bloomington = {lat: parseFloat(39.1671327), lng: parseFloat(-86.5364272)};

        // real-time listener
        db.collection('markers').onSnapshot(snapshot => {
            let changes = snapshot.docChanges();
            changes.forEach(change => {
                if(change.type == 'added'){
                    console.log(change.doc.data());
                    dbMarkers.push(change.doc.data());
                    addMarker(change.doc.data());
                } else if (change.type == 'removed'){
                    //let li = cafeList.querySelector('[data-id=' + change.doc.id + ']');
                    //cafeList.removeChild(li);
                }
            });
        });

        // Initialize and add the map
        function initMap() {
            mapBounds = new google.maps.LatLngBounds();
            // Find the center of the coordinates
            // centerPoint = averageGeolocation(markers);
            // The map, centered in between all of the photo coordinates
            map = new google.maps.Map(
                //document.getElementById('map'), {zoom: 4, center: centerPoint});
                document.getElementById('map'), {zoom: 12, center: bloomington});
        }
        function addMarker(marker) {
            var myLatlng = new google.maps.LatLng(marker.latitude,marker.longitude);
            // Create a new marker object
            var marker = new google.maps.Marker({
                position: myLatlng,
                icon: getIcon(marker.icon),
                url: marker.photoURL
            });
            // Add marker object to array of map markers
            mapMarkers.push(marker);
            // Add a click listener for the marker
            /*
            google.maps.event.addListener(marker, 'click', function() {
                window.location.href = this.url;
            });
            */
            // To add the marker to the map, call setMap();
            marker.setMap(map);
            // Increase the size of the map, if needed
            mapBounds.extend(marker.position);
            // Resize the map to fit all of the photos
            map.fitBounds(mapBounds);
        }

        function resetMap() {
          mapMarkers.forEach(mapMarker => {
            mapMarker.setMap(null);
          });
          map.setCenter(bloomington);
          map.setZoom(12);
        }

        function clearDatabase() {
          const markers = db.collection("markers")
          .get()
          .then(function(querySnapshot) {
            querySnapshot.forEach(function(doc) {
                db.collection('markers').doc(doc.id).delete();
            });
          });
          resetMap();
          dbMarkers = [];
          mapMarkers = [];
        }

        function simulateCall(disaster) {
          console.log('Disaster: ' + disaster);
          if (disaster == 'storm') {
            thisCall = shuffledStorm[shuffledStorm.length-1];
            shuffledStorm.pop();
            console.log('Storm items remaining: ' + shuffledStorm.length);
            writeEmergency(thisCall);
          } else if (disaster == 'crash') {
            thisCall = shuffledCrash[shuffledCrash.length-1];
            console.log('Crash items remaining: ' + shuffledCrash.length);
            shuffledCrash.pop();
            writeEmergency(thisCall);
          } else if (disaster == 'explosion') {
            thisCall = shuffledExplosion[shuffledExplosion.length-1];
            console.log('Explosion items remaining: ' + shuffledExplosion.length);
            shuffledExplosion.pop();
            writeEmergency(thisCall);
          }
        }

        function writeEmergency(emergency) {
          console.log('Emergency: ' + emergency.description);
          db.collection('markers').add({
              latitude: emergency.latitude,
              longitude: emergency.longitude,
              description: emergency.description,
              icon: emergency.icon
          });
        }

        function getIcon(icon) {
          const iconBase = 'https://su20-i516-final-eoc.web.app/images/icons/';
          return iconBase + icon + '.png';
        }

        /** UTILITY FUNCTIONS **/
        function getRndInteger(min, max) {
          return Math.floor(Math.random() * (max - min) ) + min;
        }
        function shuffle(array) {
          var currentIndex = array.length, temporaryValue, randomIndex;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }
          return array;
        }
        function sleep(milliseconds) {
          const date = Date.now();
          let currentDate = null;
          do {
            currentDate = Date.now();
          } while (currentDate - date < milliseconds);
        }
    </script>
    
    <script src="app.js"></script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhX8U4k3Msr1cSI62hHg-8V3M0PvLD8pI&callback=initMap"></script>
</body>
</html>
